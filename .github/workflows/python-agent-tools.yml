name: python-agent-tools-ci

on:
  workflow_call:

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service:
          - name: agent-runtime
            path: services/agent-runtime
          - name: tool-gateway
            path: services/tool-gateway

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        working-directory: ${{ matrix.service.path }}
        run: poetry install

      - name: Lint
        working-directory: ${{ matrix.service.path }}
        run: poetry run ruff check .

      - name: Run Tests
        working-directory: ${{ matrix.service.path }}
        run: poetry run pytest

      - name: Test Configuration Loading (agent-runtime only)
        if: matrix.service.name == 'agent-runtime'
        working-directory: services/agent-runtime
        run: poetry run python tests/test_config_manual.py

      - name: Build Docker image
        run: |
          IMAGE=ghcr.io/${{ github.repository }}-${{ matrix.service.name }}
          docker build -t $IMAGE:latest ${{ matrix.service.path }}

      - name: Log in to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !startsWith(github.repository, 'doon728/tmpl-')
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push Docker image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !startsWith(github.repository, 'doon728/tmpl-')
        run: |
          IMAGE=ghcr.io/${{ github.repository }}-${{ matrix.service.name }}
          docker push $IMAGE:latest
